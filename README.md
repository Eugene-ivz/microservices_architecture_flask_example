# Описание проекта

Учебный проект по развертыванию приложения с микросервисной архитектурой с помощью **docker-compose**.

Проект состоит из 4-х микросервисов, 2 из которых основаны на **Flask** и 2 простых **python** пакета.
Позволяет пользователю зарегистрироваться, загрузить файл в **pdf** формате, конвертировать и скачать его
в **txt** формате. Для скачивания необходимо ввести идентификатор конвертированного файла, его выдает **notification** сервис
в stdout
(или же реализовать отправку идентификатора на почту пользователя).

  + Auth - сервис авторизации
  + Entry - сервис как точка входа с базовым html фронтендом
  + Converter - сервис, отвечающий за конвертацию файла
  + Notification - сервис, выдающий идентификатор конвертированного файла

Используется базовая аутентификация для получения jwt httponly cookie. Далее для доступа к маршрутам и эндпоинтам требуется куки.
Данные базовой аутентификации хранятся в postgresql. Файлы хранятся в mongodb(gridfs).

Используется брокер сообщений rabbitmq для связи между сервисами entry -> converter -> notification

Используется nginx как реверс-прокси для auth и entry сервисов для предоставления единого доступа через localhost и порт 80.

## Маршруты

  entry сервис
  
  Из браузера доступ по адресу **http://localhost**

  + / - стартовая страница
  + auth/registration - регистрация нового пользователя
  + auth/login - вход в систему
  + auth/logout - выход из системы
  + converter/upload - загрузка pdf файла в сервис
  + converter/download - загрузка txt файла на устройство пользователя

## Эндпоинты

  auth сервис
   
  + POST api/auth/login - создание jwt при базовой аутентификации формата "username:password"
  + POST api/auth/logout - занесение jwt в список отозванных токенов в бд
  + POST api/auth/validate - валидация jwt в куки
  + GET api/users/all - список всех пользователей
  + GET api/users/whoami - получение данных пользователя
  + POST api/users/create - занесение данных пользователя в бд
  + DELETE api/users//<uuid:id>/delete - удаление данных пользователя из бд

## Запуск

Находясь в директории с файлом docker-compose.yml выполнить в терминале:
```
docker-compose build
docker-compose up
```
Для ручного запуска в окружении разработки необходимо установить переменную окружения:
```
FLASK_ENV=development
или
FLASK_ENV=production
```
Далее из папки с сервисом
```
python -m run.py
или напрямую файл сервиса main.py
```

## Тесты

Для тестов требуется отдельная тестовая postgresql
пооставить можно следующей командой:
```
docker run --name postgres_test -p 5556:5432 -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=test_users -d postgres:16.2
```

Находясь в директории с сервисом выполнить:
```
pytest
или
python -m pytest -v
```
В данный момент тесты присутствуют только в auth сервисе


