# Описание проекта

Учебный проект по развертыванию приложения с микросервисной архитектурой с помощью **docker-compose**.

Проект состоит из 4-х микросервисов, 2 из которых основаны на **Flask** и 2 простых **python** пакета.
Позволяет пользователю зарегистрироваться, загрузить файл в **pdf** формате, конвертировать и скачать его
в **txt** формате. Для скачивания необходимо ввести идентификатор конвертированного файла, его выдает **notification** сервис
в stdout
(или же реализовать отправку идентификатора на почту пользователя).

  + Auth - сервис авторизации
  + Entry - сервис как точка входа с базовым html фронтендом
  + Converter - сервис, отвечающий за конвертацию файла
  + Notification - сервис, выдающий идентификатор конвертированного файла

Используется авторизация через jwt httponly cookie. Данные базовой авторизации хранятся в postgresql. Файлы хранятся в mongodb(gridfs).

Используется брокер сообщений rabbitmq для связи между сервисами entry -> converter -> notification

## Маршруты

  entry сервис порт 5020
  
  Из браузера доступ по адресу **http://localhost:5020**

  + / - стартовая страница
  + auth/registration - регистрация нового пользователя
  + auth/login - вход в систему
  + auth/logout - выход из системы
  + converter/upload - загрузка pdf файла в сервис
  + converter/download - загрузка txt файла на устройство пользователя

## Эндпоинты

  auth сервис порт 5010
   
  + POST auth/login - создание jwt
  + POST auth/logout - занесение jwt в список отозванных токенов в бд
  + POST auth/validate - валидирование jwt
  + GET users/all - список всех пользователей
  + GET users/whoami - получение данных пользователя
  + POST users/create - создание записи пользователя в бд
  + DELETE users//<uuid:id>/delete - удаление записи пользователя из бд

## Запуск

Находясь в директории с файлом docker-compose.yml выполнить в терминале:
```
docker-compose build
docker-compose up
```
Для ручного запуска в окружении разработки необходимо установить переменную окружения:
```
FLASK_ENV=development
или
FLASK_ENV=production
```
Далее из папки с сервисом
```
python -m run.py
или напрямую файл сервиса main.py
```

## Тесты

Для тестов требуется отдельная тестовая postgresql
пооставить можно следующей командой:
```
docker run --name postgres_test -p 5556:5432 -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=test_users -d postgres:16.2
```

Находясь в директории с сервисом выполнить:
```
pytest
или
python -m pytest -v
```
В данный момент тесты присутствуют только в auth сервисе


